var stompClient=null;var timeformat="DD/MM HH:mm:ss";var timeformatsmall="HH:mm:ss";var errorlistJson={};var array_regular=[];var array_spec=[];function findeByhash(b,c){for(var a=0;a<c.length;a++){if(c[a].hash===b.hash){return a}}return -1}function reDrawErrorList(b,o,h){var d=document.getElementById("check_level_"+h.level);var g=false;if(d!==null){if(d.checked){g=true;var f=document.querySelectorAll(".filter-switch");for(var k=0;k<f.length;k++){if(f[k].checked){var e=$("#"+f[k].value+"_input").val();var n=new RegExp(e,"i");if(f[k].value==="metric"){g=n.test(h.info.name)}else{if(h.info.tags[f[k].value]){g=n.test(h.info.tags[f[k].value].value)}}if(!g){break}}}}}if(h.isspec===0){var m=findeByhash(h,array_regular);if(g){if(m===-1){array_regular.push(h);array_regular.sort(function(p,i){var q=$("select#ident_tag").val();return compareMetric(p,i,q)});var l=findeByhash(h,array_regular);if(l<array_regular.length-1){drawRaw(array_regular[l],o,array_regular[l+1].hash)}else{drawRaw(array_regular[l],o)}}else{array_regular[m]=h;drawRaw(array_regular[m],o,array_regular[m].hash,true)}}else{if(m!==-1){var c=h.hash;array_regular.splice(m,1);o.find("tbody tr#"+c).fadeOut(400,function(){o.find("tbody tr#"+c).remove()})}}}else{var j=findeByhash(h,array_spec);if(g){if(j===-1){array_spec.push(h);array_spec.sort(function(p,i){var q=$("select#ident_tag").val();return compareMetric(p,i,q)});var l=findeByhash(h,array_spec);if(l<array_spec.length-1){drawRaw(array_spec[l],o,array_spec[l+1].hash)}else{drawRaw(array_spec[l],o,0)}}else{array_spec[j]=h;drawRaw(array_spec[j],o,array_spec[j].hash,true)}}else{if(j!==-1){var a=h.hash;array_spec.splice(j,1);o.find("tbody tr#"+a).fadeOut(400,function(){o.find("tbody tr#"+a).remove()})}}}}function DrawErrorList(d,f){$("select").attr("disabled",true);f.find("tbody").html("");array_regular=[];array_spec=[];for(var c in d){var g=d[c];var a=document.getElementById("check_level_"+g.level);filtred=true;if(a!==null){if(a.checked){filterelems=document.querySelectorAll(".filter-switch");for(var b=0;b<filterelems.length;b++){if(filterelems[b].checked){var e=$("#"+filterelems[b].value+"_input").val();regex=new RegExp(e,"i");if(filterelems[b].value==="metric"){filtred=regex.test(g.info.name)}else{if(g.info.tags[filterelems[b].value]){filtred=regex.test(g.info.tags[filterelems[b].value].value)}}if(!filtred){break}}}if(filtred){if(g.isspec===0){array_regular.push(g)}else{array_spec.push(g)}}}else{delete d[c]}}}array_spec.sort(function(i,h){var j=$("select#ident_tag").val();return compareMetric(i,h,j)});array_regular.sort(function(i,h){var j=$("select#ident_tag").val();return compareMetric(i,h,j)});for(c in array_spec){drawRaw(array_spec[c],f)}for(c in array_regular){drawRaw(array_regular[c],f)}f.find("tbody input.rawflat").iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_flat-green"});$("select").attr("disabled",false)}function drawRaw(c,l,g,e){if(typeof(g)==="undefined"){g=null}if(typeof(e)===e){type=false}var m="";if(c.isspec===1){m=c.message}else{var b=0;var h=0;for(var k in c.values){b=b+c.values[k].value;h++}b=b/h;if(b>1000){b=format_metric(c.values[k].value)}else{b=b.toFixed(2)}m=m+b}var j="";if(typeof(c.time)!=="undefined"){j=moment(c.time*1).format(timeformatsmall)}var i="";var d="red";if(c.action===2){i="fa-long-arrow-down";d="green"}if(c.action===3){i="fa-long-arrow-up";d="red"}var a="level_"+c.level;if(c.isspec!==0){a="spec"}if(!e){var f="";f=f+'<tr id="'+c.hash+'" class="'+a+'">';if(c.isspec===0){f=f+'<td class="icons"><input type="checkbox" class="rawflat" name="table_records"><div class="fa-div"> <a href="'+cp+"/chart/"+c.hash+'" target="_blank"><i class="fa fa-area-chart"></i></a><i class="action fa '+i+'" style="color:'+d+';"></i></div></td>'}else{f=f+'<td><i class="fa fa-bell" style="color:red; font-size: 18px;"></i></td>'}f=f+'<td class="level"><div>'+c.levelname+"</div></td>";f=f+"<td>"+c.info.name+"</td>";f=f+"<td>"+c.info.tags[$("select#ident_tag").val()].value+"</td>";f=f+'<td class="message">'+m+"</td>";f=f+'<td class="">'+moment(c.starttimes[c.level]*1).format(timeformat)+"</td>";f=f+'<td class="timelocal" >'+moment().format(timeformatsmall)+"</td>";f=f+'<td class="timech" time="'+c.time+'">'+j+"</td>";f=f+"</tr>";if(g===null){l.find("tbody").append(f)}else{if(g===0){if(l.find("tbody tr").first().length===0){l.find("tbody").append(f)}else{l.find("tbody tr").first().before(f)}}else{l.find("tbody tr#"+g).before(f)}}l.find("tbody tr#"+c.hash+" input.rawflat").iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_flat-green"})}else{l.find("tbody tr#"+g).attr("class",a);l.find("tbody tr#"+g+" .level div").html(c.levelname);l.find("tbody tr#"+g+" .timelocal").html(moment().format(timeformatsmall));l.find("tbody tr#"+g+" .timech").html(j+" ("+timems(c.time-l.find("tbody tr#"+g+" .timech").attr("time"))+" Repeat "+c.index+")");l.find("tbody tr#"+g+" .timech").attr("time",c.time);l.find("tbody tr#"+g+" .message").html(m);if(i!==""){l.find("tbody tr#"+g+" .icons i.action").attr("class","action fa "+i);l.find("tbody tr#"+g+" .icons i.action").css("color",d)}}$(".summary .Tablecount").html(l.find("tbody tr").length);$(".summary .regcount").html(array_regular.length);$(".summary .Speccount").html(array_spec.length)}var beginlisen=false;function startlisen(){if(!beginlisen){beginlisen=true;var e=$("form.form-filter").serializeArray();for(var d in switcherylist){switcherylist[d].disable()}var b=cp+"/startlisener";var f=$("meta[name='_csrf_header']").attr("content");var c=$("meta[name='_csrf']").attr("content");var a={};a.levels=[];jQuery.each(e,function(g,h){if(h.value==="on"){if(h.name.indexOf("check_level_")===0){a.levels.push(h.name.replace("check_level_",""))}}});a.sotoken=sotoken;$.ajax({dataType:"json",type:"POST",url:b,data:a,beforeSend:function(g){g.setRequestHeader(f,c)}}).done(function(h){beginlisen=false;for(var g in switcherylist){switcherylist[g].enable()}})}}var switcherylist=[];$(document).ready(function(){$(".timech").each(function(){val=$(this).html();time=moment(parseFloat(val));$(this).html(time.format(timeformat))});$(".autocomplete-append-metric").each(function(){var h=$(this);var i=cp+"/getfiltredmetricsnames?filter=^(.*)$";$.getJSON(i,null,function(j){h.autocomplete({lookup:j.data,appendTo:".autocomplete-container-metric"})})});$(".autocomplete-append").each(function(){var h=$(this);var i=cp+"/gettagvalue?key="+h.attr("tagkey")+"&filter=^(.*)$";$.getJSON(i,null,function(j){h.autocomplete({lookup:j.data,appendTo:".autocomplete-container_"+h.attr("tagkey")})})});var b=document.querySelectorAll(".js-switch-small");for(var c=0;c<b.length;c++){if(typeof(filterJson[b[c].id])!=="undefined"){if(filterJson[b[c].id]!==""){if(!b[c].checked){$(b[c]).trigger("click")}}else{if(b[c].checked){$(b[c]).trigger("click")}}}var g=new Switchery(b[c],{size:"small",color:"#26B99A"});switcherylist.push(g);b[c].onchange=function(){DrawErrorList(errorlistJson,$(".metrictable"))}}var f=true;$("body").on("change",".js-switch-small",function(){if(!f){startlisen();f=true}else{f=false}});$("body").on("blur",".filter-input",function(){DrawErrorList(errorlistJson,$(".metrictable"))});$(".filter-input").each(function(){$(this).val(filterJson[$(this).attr("name")])});var a=new SockJS(cp+"/subscribe");var d=Stomp.over(a);d.debug=null;var e={};e[headerName]=token;d.connect(e,function(h){d.subscribe("/user/"+uuid+"/"+sotoken+"/errors",function(i){var j=JSON.parse(i.body);if(errorlistJson[j.hash]){j.index=errorlistJson[j.hash].index}if(typeof(j.index)!=="undefined"){j.index=j.index+1}else{j.index=0}if(j.level===-1){delete errorlistJson[j.hash]}else{errorlistJson[j.hash]=j}reDrawErrorList(errorlistJson,$(".metrictable"),j);if(Object.keys(errorlistJson).length>200){$("#manyalert").fadeIn()}else{$("#manyalert").fadeOut()}})},function(h){$("#lostconnection").modal("show")});startlisen();$(window).bind("beforeunload",function(){var i=cp+"/stoplisener";var k=$("meta[name='_csrf_header']").attr("content");var j=$("meta[name='_csrf']").attr("content");var h={};h.sotoken=sotoken;$.ajax({dataType:"json",type:"POST",url:i,data:h,beforeSend:function(l){l.setRequestHeader(k,j)}})});$("body").on("change","#ident_tag",function(){DrawErrorList(errorlistJson,$(".metrictable"))});$("body").on("click","#Default",function(){var j=$("form.form-filter").serializeArray();filterJson={};jQuery.each(j,function(l,m){if(m.value!==""){filterJson[m.name]=m.value}});var h={};h.filter=JSON.stringify(filterJson);var k=$("meta[name='_csrf_header']").attr("content");var i=$("meta[name='_csrf']").attr("content");url=cp+"/savefilter";$.ajax({dataType:"json",type:"POST",url:url,data:h,beforeSend:function(l){l.setRequestHeader(k,i)}}).done(function(l){if(l.sucsses){alert("Data Saved ")}else{alert("Request failed")}}).fail(function(l,m){alert("Request failed")})});$("body").on("click","#Clear_reg",function(){$(".bulk_action tbody input[name='table_records']:checked").each(function(){var h={};h.hash=$(this).parents("tr").attr("id");var j=$("meta[name='_csrf_header']").attr("content");var i=$("meta[name='_csrf']").attr("content");url=cp+"/resetregression";$.ajax({dataType:"json",type:"POST",url:url,data:h,beforeSend:function(k){k.setRequestHeader(j,i)}}).done(function(k){if(k.sucsses){console.log("Message Sended ")}else{console.log("Request failed")}}).fail(function(k,l){console.log("Request failed")})})});$("body").on("click","#Show_chart",function(){hashes="";if($(".bulk_action tbody input[name='table_records']:checked").length===1){hashes="/"+$(".bulk_action tbody input[name='table_records']:checked").first().parents("tr").attr("id")}else{hashes="?hashes=";$(".bulk_action tbody input[name='table_records']:checked").each(function(){hashes=hashes+$(this).parents("tr").attr("id")+";"})}var h=window.open(cp+"/chart"+hashes,"_blank");h.focus()})});