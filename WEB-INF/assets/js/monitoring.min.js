var socket;var stompClient;var timeformat="DD/MM HH:mm:ss";var timeformatsmall="HH:mm:ss";var errorlistJson={};var array_regular=[];var array_spec=[];function connectstompClient(){var c={};c[headerName]=token;c.sotoken=sotoken;var b=$("form.form-filter").serializeArray();var a=[];jQuery.each(b,function(d,e){if(e.value==="on"){if(e.name.indexOf("check_level_")===0){a.push(e.name.replace("check_level_",""))}}});c.levels=a;realtimeconnect(c)}function realtimeconnect(a){console.log("connect START");socket=new SockJS(cp+"/subscribe");stompClient=Stomp.over(socket);stompClient.debug=null;stompClient.connect(a,function(b){console.log("monitor connected");stompClient.subscribe("/user/"+uuid+"/"+sotoken+"/errors",aftersubscribe)},function(b){console.log("can not connect");realtimeconnect(a)})}function aftersubscribe(a){$(".metrictable").find("tr.wait").remove();var b=JSON.parse(a.body);if(errorlistJson[b.hash]){b.index=errorlistJson[b.hash].index}if(typeof(b.index)!=="undefined"){b.index=b.index+1}else{b.index=0}if(errorlistJson[b.hash]){if(b.time>=errorlistJson[b.hash].time){if(b.level===-1){delete errorlistJson[b.hash]}else{errorlistJson[b.hash]=b}reDrawErrorList(errorlistJson,$(".metrictable"),b)}}else{if(b.level===-1){delete errorlistJson[b.hash]}else{errorlistJson[b.hash]=b}reDrawErrorList(errorlistJson,$(".metrictable"),b)}if(Object.keys(errorlistJson).length>200){$("#manyalert").fadeIn()}else{$("#manyalert").fadeOut()}}function findeByhash(b,c){for(var a=0;a<c.length;a++){if(c[a].hash===b.hash){return a}}return -1}function reDrawErrorList(b,o,h){var d=document.querySelectorAll("[name=check_level_"+h.level+"]");d=d[0];var g=false;if((typeof d!=="undefined")&(d!==null)){if(d.checked){g=true;var f=document.querySelectorAll(".filter-switch");for(var k=0;k<f.length;k++){if(f[k].checked){var e=$("[name="+f[k].value+"_input]").val();var n=new RegExp(e,"i");if(f[k].value==="metric"){g=n.test(h.info.name)}else{if(h.info.tags[f[k].value]){g=n.test(h.info.tags[f[k].value].value)}}if(!g){delete b[h.hash];break}}}}else{delete b[h.hash]}}if(h.isspec===0){var m=findeByhash(h,array_regular);if(g){if(m===-1){array_regular.push(h);array_regular.sort(function(p,i){var q=$("select#ident_tag").val();return compareMetric(p,i,q)});var l=findeByhash(h,array_regular);if(l<array_regular.length-1){drawRaw(array_regular[l],o,array_regular[l+1].hash)}else{drawRaw(array_regular[l],o)}}else{array_regular[m]=h;drawRaw(array_regular[m],o,array_regular[m].hash,true)}}else{if(m!==-1){h.index=0;var c=h.hash;array_regular.splice(m,1);o.find("tbody tr#"+c).fadeOut(400,function(){o.find("tbody tr#"+c).remove()})}}}else{var j=findeByhash(h,array_spec);if(g){if(j===-1){array_spec.push(h);array_spec.sort(function(p,i){var q=$("select#ident_tag").val();return compareMetric(p,i,q)});var l=findeByhash(h,array_spec);if(l<array_spec.length-1){drawRaw(array_spec[l],o,array_spec[l+1].hash)}else{drawRaw(array_spec[l],o,0)}}else{array_spec[j]=h;drawRaw(array_spec[j],o,array_spec[j].hash,true)}}else{if(j!==-1){h.index=0;var a=h.hash;array_spec.splice(j,1);o.find("tbody tr#"+a).fadeOut(400,function(){o.find("tbody tr#"+a).remove()})}}}}function DrawErrorList(d,f){$("select").attr("disabled",true);f.find("tbody").html("");array_regular=[];array_spec=[];for(var c in d){var g=d[c];var a=document.querySelectorAll("[name=check_level_"+g.level+"]");a=a[0];filtred=true;if((typeof a!=="undefined")&(a!==null)){if(a.checked){var h=document.querySelectorAll(".filter-switch");for(var b=0;b<h.length;b++){if(h[b].checked){var e=$("[name="+h[b].value+"_input]").val();regex=new RegExp(e,"i");if(h[b].value==="metric"){filtred=regex.test(g.info.name)}else{if(g.info.tags[h[b].value]){filtred=regex.test(g.info.tags[h[b].value].value)}}if(!filtred){break}}}if(filtred){if(g.isspec===0){array_regular.push(g)}else{array_spec.push(g)}}else{delete d[c]}}else{delete d[c]}}}array_spec.sort(function(j,i){var k=$("select#ident_tag").val();return compareMetric(j,i,k)});array_regular.sort(function(j,i){var k=$("select#ident_tag").val();return compareMetric(j,i,k)});for(c in array_spec){drawRaw(array_spec[c],f)}for(c in array_regular){drawRaw(array_regular[c],f)}f.find("tbody input.rawflat").iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_flat-green"});$("select").attr("disabled",false)}function drawRaw(c,n,g,e){if(typeof(g)==="undefined"){g=null}if(typeof(e)===e){type=false}var o="";if(c.isspec===1){o=c.message}else{var b=0;var h=0;for(var l in c.values){b=b+c.values[l].value;h++}b=b/h;if(b>1000){b=format_metric(c.values[l].value)}else{if(!Number.isInteger(b)){b=b.toFixed(2)}}o=o+b}var k="";if(typeof(c.time)!=="undefined"){k=moment(c.time*1).format(timeformatsmall)}var j="";var d="red";if(c.action===2){j="fas fa-long-arrow-alt-down";d="green"}if(c.action===3){j="fas fa-long-arrow-alt-up";d="red"}var a="level_"+c.level;if(c.isspec!==0){a=a+" spec"}if(c.flap>5){a=a+" flapdetect"}if(!e){var f="";f=f+'<tr id="'+c.hash+'" class="'+a+'" time="'+c.time+'">';if(c.isspec===0){f=f+'<td class="icons"><input type="checkbox" class="rawflat" name="table_records"><div class="fa-div"> <a href="'+cp+"/chart/"+c.hash+'" target="_blank"><i class="fa fas fa-chart-area"></i></a><a href="'+cp+"/history/"+c.hash+'" target="_blank"><i class="fa fa-history"></i></a> <i class="action fa '+j+'" style="color:'+d+';"></i></div></td>'}else{f=f+'<td><div class="fa-div"><i class="fa fa-bell"></i> <a href="'+cp+"/history/"+c.hash+'" target="_blank"><i class="fa fa-history"></i></a></div></td>'}f=f+'<td class="level"><div>'+c.levelname+"</div></td>";if(c.isspec===0){f=f+'<td><a href="'+cp+"/metriq/"+c.hash+'" target="_blank">'+c.info.name+"</a></td>"}else{f=f+"<td>"+c.info.name+"</td>"}if(c.info.tags[$("select#ident_tag").val()]){f=f+"<td>"+c.info.tags[$("select#ident_tag").val()].value+"</td>"}else{f=f+"<td>NaN</td>"}if(c.isspec===0){var i="fas fa-long-arrow-alt-down";if(c.upstate){i="fas fa-long-arrow-alt-up"}f=f+'<td class="message"><i class="action fa '+i+'"></i> '+o+"</td>"}else{f=f+'<td class="message">'+o+"</td>"}var m=c.starttimes[c.level]?c.starttimes[c.level]:c.time;f=f+'<td class="starttime">'+moment(m*1).format(timeformat)+"</td>";f=f+'<td class="timelocal" >'+moment().format(timeformatsmall)+"</td>";f=f+"</tr>";if(g===null){n.find("tbody").append(f)}else{if(g===0){if(n.find("tbody tr").first().length===0){n.find("tbody").append(f)}else{n.find("tbody tr").first().before(f)}}else{n.find("tbody tr#"+g).before(f)}}n.find("tbody tr#"+c.hash+" input.rawflat").iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_flat-green"})}else{n.find("tbody tr#"+g).attr("class",a);n.find("tbody tr#"+g+" .level div").html(c.levelname);if(c.starttimes[c.level]){n.find("tbody tr#"+g+" .starttime").html(moment(c.starttimes[c.level]*1).format(timeformat))}n.find("tbody tr#"+g+" .timelocal").html(moment().format(timeformatsmall));n.find("tbody tr#"+g).attr("time",c.time);if(c.isspec===0){var i="fas fa-long-arrow-alt-down";if(c.upstate){i="fas fa-long-arrow-alt-up"}n.find("tbody tr#"+g+" .message").html('<i class="action fa '+i+'"></i> '+o)}else{n.find("tbody tr#"+g+" .message").html(o)}if(j!==""){n.find("tbody tr#"+g+" .icons i.action").attr("class","action fa "+j);n.find("tbody tr#"+g+" .icons i.action").css("color",d)}}$(".summary .Tablecount").html(n.find("tbody tr").length);$(".summary .regcount").html(array_regular.length);$(".summary .Speccount").html(array_spec.length)}var beginlisen=false;var switcherylist=[];$(document).ready(function(){$(".autocomplete-append-metric").each(function(){var c=$(this);var d=cp+"/getfiltredmetricsnames?filter="+encodeURIComponent("^(.*)$");$.getJSON(d,null,function(e){c.autocomplete({lookup:e.data,minChars:0})})});$(".autocomplete-append").each(function(){var c=$(this);var d=cp+"/gettagvalue?key="+c.attr("tagkey")+"&filter="+encodeURIComponent("^(.*)$");$.getJSON(d,null,function(e){c.autocomplete({lookup:Object.keys(e.data),minChars:0})})});var a=0;$(".js-switch-small").each(function(){if(typeof(filterJson[$(this).attr("name")])!=="undefined"){if(filterJson[$(this).attr("name")]!==""){$(this).parents(".tagfilter").show();a++;if(!$(this).checked){$(this).trigger("click")}}else{if($(this).checked){$(this).trigger("click")}}}var c=new Switchery($(this).get(0),{size:"small",color:"#26B99A"});switcherylist.push(c);$(this).get(0).onchange=function(){DrawErrorList(errorlistJson,$(".metrictable"))}});var b=true;$("body").on("change",".js-switch-small",function(){if(!b){var d=$("form.form-filter").serializeArray();var c=[];jQuery.each(d,function(e,f){if(f.value==="on"){if(f.name.indexOf("check_level_")===0){c.push(f.name.replace("check_level_",""))}}});stompClient.send("/input/chagelevel/",{},JSON.stringify(c));b=true}else{b=false}});$("body").on("blur",".filter-input",function(){DrawErrorList(errorlistJson,$(".metrictable"))});$(".filter-input").each(function(){$(this).val(filterJson[$(this).attr("name")])});connectstompClient();$("body").on("change","#ident_tag",function(){DrawErrorList(errorlistJson,$(".metrictable"))});$("body").on("click","#Default",function(){var e=$("form.form-filter").serializeArray();filterJson={};jQuery.each(e,function(g,h){if(h.value!==""){filterJson[h.name]=h.value}});var c={};c.filter=JSON.stringify(filterJson);var f=$("meta[name='_csrf_header']").attr("content");var d=$("meta[name='_csrf']").attr("content");url=cp+"/savefilter";$.ajax({dataType:"json",type:"POST",url:url,data:c,beforeSend:function(g){g.setRequestHeader(f,d)}}).done(function(g){if(g.sucsses){alert("Data Saved ")}else{alert("Request failed")}}).fail(function(g,h){alert("Request failed")})});$("body").on("click","#Clear_reg",function(){$(".bulk_action tbody input[name='table_records']:checked").each(function(){var c={};c.hash=$(this).parents("tr").attr("id");var e=$("meta[name='_csrf_header']").attr("content");var d=$("meta[name='_csrf']").attr("content");url=cp+"/resetregression";$.ajax({dataType:"json",type:"POST",url:url,data:c,beforeSend:function(f){f.setRequestHeader(e,d)}}).done(function(f){if(f.sucsses){console.log("Message Sended ")}else{console.log("Request failed")}}).fail(function(f,g){console.log("Request failed")})})});$("body").on("click","#Show_chart",function(){hashes="";if($(".bulk_action tbody input[name='table_records']:checked").length===1){hashes="/"+$(".bulk_action tbody input[name='table_records']:checked").first().parents("tr").attr("id")}else{hashes="?hashes=";$(".bulk_action tbody input[name='table_records']:checked").each(function(){hashes=hashes+$(this).parents("tr").attr("id")+";"})}var c=window.open(cp+"/chart"+hashes,"_blank");c.focus()})});